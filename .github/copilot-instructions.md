# KeymapCraft - GitHub Copilot Instructions

## プロジェクト概要

**KeymapCraft**は、キーボードの配列を視覚化・編集・共有できるWebアプリケーションです。
ユーザーが自分のキーボード配列をカスタマイズし、他のユーザーと共有できるプラットフォームを提供します。

**現在のステータス**: Phase 3完了 - 主要機能は実装済み、UI/UX改善段階

## 技術スタック

- **フロントエンド**: React 19 + TypeScript
- **ビルドツール**: Vite
- **スタイリング**: TailwindCSS
- **状態管理**: Zustand（実装済み）
- **UI操作**: React-DnD（ドラッグ&ドロップ）
- **アニメーション**: React-Spring（予定）

## 主要機能

### 1. キーボードエディタ
- フレキシブルなキーボードレイアウト編集
- キーの位置、サイズ、文字割り当ての変更
- ドラッグ&ドロップによる直感的な操作
- 複数レイヤー対応（通常、Shift、Fn等）

### 2. プリセット配列
- JISフル配列（79キー）- Fキー付きフルサイズ
- US Wogikaze配列（69キー）- コンパクト設計
- カスタム配列の作成・保存・編集

### 3. 比較機能
- 2つの配列の並列表示
- キーごとの差分をハイライト
- 詳細な違いの説明（例：JISの「2」キーのShift+2は「"」、USでは「@」）

### 4. 共有・エクスポート
- URLでの配列共有
- JSON形式でのエクスポート/インポート
- 画像形式でのエクスポート

## 実装済み機能

### コア機能
- **キーボード表示・編集**: 0.5u単位での精密な配置とサイズ調整
- **ドラッグ&ドロップ**: 直感的なキー移動機能
- **レイヤー管理**: 通常、Shift、Fn、AltGrレイヤーの切り替え
- **キー操作**: 追加、複製、削除、選択・編集

### プリセット配列
- **JISフル配列（79キー）**: Fキー付き完全な日本語配列
- **US Wogikaze配列（69キー）**: コンパクトなUS ANSI配列

### UI/UX機能
- **折りたたみメニュー**: 各機能セクションを個別に展開/折りたたみ
- **リアルタイムプレビュー**: 編集内容の即座反映
- **レスポンシブデザイン**: デスクトップ/タブレット対応

### 比較・共有機能
- **レイアウト比較**: 2つの配列間の差分表示
- **JSONエクスポート/インポート**: 配列データの保存・読み込み
- **画像エクスポート**: PNG形式での配列画像出力
- **URL共有**: ワンクリックでの配列共有

## データ構造

### KeyboardLayout
```typescript
interface KeyboardLayout {
  id: string;
  name: string;
  description?: string;
  keys: KeyDefinition[];
  metadata: LayoutMetadata;
  createdAt: Date;
  updatedAt: Date;
}
```

### KeyDefinition
```typescript
interface KeyDefinition {
  id: string;
  position: { x: number; y: number }; // グリッド座標
  size: { width: number; height: number }; // キーサイズ（uユニット）
  keycode: string; // 物理キーコード
  legends: {
    normal: string;      // 通常入力
    shift: string;       // Shift同時押し
    altgr?: string;      // AltGr（US International等）
    fn?: string;         // Fnキー同時押し
  };
  style?: {
    backgroundColor?: string;
    textColor?: string;
    borderColor?: string;
  };
}
```

### LayoutMetadata
```typescript
interface LayoutMetadata {
  language: string;     // 'ja', 'en', etc.
  region: string;       // 'JP', 'US', etc.
  layoutType: string;   // 'JIS', 'ANSI', 'ISO'
  keyCount: number;
  author?: string;
  tags?: string[];
}
```

## ディレクトリ構造

```
src/
├── components/
│   ├── KeyboardEditor/       # キーボード編集関連
│   │   ├── KeyboardCanvas.tsx
│   │   ├── KeyComponent.tsx
│   │   ├── KeyEditor.tsx
│   │   └── Toolbar.tsx
│   ├── LayoutManager/        # レイアウト管理
│   │   ├── PresetSelector.tsx
│   │   └── LayoutImporter.tsx
│   ├── Comparison/           # 比較機能
│   │   └── LayoutComparison.tsx
│   └── UI/                   # 共通UIコンポーネント
│       └── CollapsibleSection.tsx
├── stores/                   # 状態管理
│   └── keyboardStore.ts
├── data/                     # プリセットデータ
│   └── presets/
│       ├── jisFull.ts
│       └── us.ts
├── utils/                    # ユーティリティ関数
│   └── exportUtils.ts
└── types/                    # TypeScript型定義
    └── keyboard.ts
```

## 開発ガイドライン

### コーディングスタイル
- **TypeScript**: 厳密な型付けを心がける
- **関数型**: 可能な限り関数型プログラミングを採用
- **コンポーネント**: 小さく再利用可能なコンポーネントに分割
- **ネーミング**: 日本語プロジェクトですが、コード内は英語で統一

### スタイリング
- **TailwindCSS**: ユーティリティファーストのアプローチ
- **ダークテーマ**: メインテーマはダーク
- **レスポンシブ**: モバイルファーストデザイン
- **アニメーション**: 適度なアニメーションで操作感を向上

### 状態管理
- **Zustand**: 軽量で使いやすい状態管理
- **不変性**: 状態の更新は常に不変性を保つ
- **分離**: UI状態とビジネスロジックを分離

## 特別な要件

### キーボード表示
- キーは物理的な配置を正確に再現
- キーサイズは標準的なuユニット（1u = 約15mm）で管理、0.25u単位での精密調整対応
- キートップには通常文字とShift文字を両方表示
- レイヤーごとにキーの色分け表示

### ユーザビリティ
- **直感的な編集**: ドラッグ&ドロップ時の視覚的ガイド、キー辺のリサイズ操作
- **ダイレクト入力**: キー選択中の直接入力、Shift+入力での自動振り分け
- **アクセシビリティ**: required inputの視覚的警告、キーボードナビゲーション
- **範囲選択**: 複数キーの一括操作機能（計画中）

### 国際化対応
- JIS配列とUS配列の正確な違いを表現
- 各国の配列に対応できる拡張性
- Unicode文字の適切な表示

### パフォーマンス
- 大量のキー（100+）でもスムーズな操作
- リアルタイムな編集プレビュー
- 効率的な再レンダリング

## 実装優先度

### Phase 1 (MVP) ✅ 完了
1. 基本的なキーボード表示
2. JISフル/US配列プリセット
3. 基本的なキー編集

### Phase 2 ✅ 完了
1. ドラッグ&ドロップ機能
2. キーサイズ調整
3. レイヤー機能

### Phase 3 ✅ 完了
1. 配列比較機能
2. 共有機能
3. エクスポート機能

### Phase 4 🚧 進行中
1. UI/UX改善
   - **ドラッグ&ドロップの改善**: ドロップ先の視覚的表示、キー辺のドラッグでサイズ変更
   - **キー内容編集の改善**: キー選択時のダイレクト入力、Shift+入力でShift欄への自動入力
   - **精密編集**: 0.25u刻みでの配置・サイズ調整
   - **入力改善**: 空のrequired input の警告表示、アクセシビリティ向上
   - **レイヤー表示改善**: キーの色でレイヤーを視覚的に表現
   - **選択解除**: 空白クリックでキー選択解除
2. アクセシビリティ
   - キーボードナビゲーション対応
   - スクリーンリーダー対応
   - コントラスト比の改善
3. パフォーマンス最適化
   - 大量キー表示の最適化
   - レンダリング効率化

### Phase 5 📋 計画中
1. **高度な編集機能**
   - 範囲選択による一括移動・編集
   - 複数キーの同時選択・操作
   - キーグループの作成・管理
2. **レイアウトテンプレート**
   - よく使用される配列パターンの保存
   - テンプレートからの新規作成
3. **詳細なカスタマイズ**
   - キーの個別スタイリング
   - アニメーション効果の追加
   - カラーテーマの選択

## 注意事項

- キーボード配列は文化的に重要な要素なので、正確性を重視
- ユーザビリティを最優先に、直感的な操作を心がける
- 将来的な機能拡張を考慮した設計にする
- プライバシーを考慮し、ローカルストレージを基本とする

## UI/UX改善の詳細要件

### ドラッグ&ドロップの改善
- **ドロップ先のプレビュー**: ドラッグ中にキーの移動先を半透明で表示
- **スナップガイド**: グリッドライン表示とスナップ機能
- **キー辺でのリサイズ**: キーの端をドラッグしてサイズ変更
- **衝突検知**: 他のキーとの重複を視覚的に警告

### ダイレクト入力機能
- **キー選択中の入力**: アクティブキーに対する直接文字入力
- **Shift修飾の自動振り分け**: Shift+文字でShift欄に自動入力
- **input優先**: フォーカスされたinputがある場合はそちらを優先
- **エスケープキー**: ESCでキー選択解除

### 精密編集機能
- **0.25u単位調整**: より細かい配置・サイズ設定
- **数値入力**: 直接数値での位置・サイズ指定
- **キーボードショートカット**: 矢印キーでの微調整

### アクセシビリティ
- **required input警告**: 空の必須項目を赤枠で表示
- **レイヤー色分け**: 通常（白）、Shift（黄）、Fn（緑）、AltGr（紫）
- **空白クリック選択解除**: キャンバスの空白部分クリックで選択解除
- **キーボードナビゲーション**: Tabキーでの要素間移動

### 将来の高度な機能
- **範囲選択**: ドラッグでの矩形選択、複数キーの一括操作
- **キーグループ**: 関連キーのグループ化と一括編集
- **テンプレート機能**: よく使用される配列パターンの保存・再利用
